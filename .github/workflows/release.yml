name: Tagged Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Tag: $tag, Version: $version"
    
    - name: Build x64
      run: dotnet publish src/WinKeysRemapper.csproj -c Release -r win-x64 --self-contained -o artifacts/win-x64 -p:Version=${{ steps.version.outputs.version }}
      
    - name: Build x86  
      run: dotnet publish src/WinKeysRemapper.csproj -c Release -r win-x86 --self-contained -o artifacts/win-x86 -p:Version=${{ steps.version.outputs.version }}
      
    - name: Build Portable
      run: dotnet publish src/WinKeysRemapper.csproj -c Release --no-self-contained -o artifacts/portable -p:Version=${{ steps.version.outputs.version }} -p:PublishTrimmed=false
    
    - name: Create ZIP files
      run: |
        Copy-Item "README.md" -Destination "artifacts/win-x64/" -Force
        Copy-Item "README.md" -Destination "artifacts/win-x86/" -Force
        Copy-Item "README.md" -Destination "artifacts/portable/" -Force
        
        Compress-Archive -Path "artifacts/win-x64/*" -DestinationPath "WinKeysRemapper-${{ steps.version.outputs.version }}-x64.zip" -Force
        Compress-Archive -Path "artifacts/win-x86/*" -DestinationPath "WinKeysRemapper-${{ steps.version.outputs.version }}-x86.zip" -Force  
        Compress-Archive -Path "artifacts/portable/*" -DestinationPath "WinKeysRemapper-${{ steps.version.outputs.version }}-portable.zip" -Force
    
    - name: Get tag message
      id: tag_message
      run: |
        $tagMessage = git tag -l --format='%(contents)' "${{ github.ref_name }}"
        $tagMessage = $tagMessage | Where-Object { $_.Trim() -ne "" }
        $formattedMessage = $tagMessage -join "`n"
        $escapedMessage = $formattedMessage -replace '"', '\"' -replace '`', '\`'
        echo "message=$escapedMessage" >> $env:GITHUB_OUTPUT
        echo "Tag message: $escapedMessage"
    
    - name: Create Release
      run: |
        $tagMessage = "${{ steps.tag_message.outputs.message }}"
        
        $releaseNotes = @"
        Release ${{ github.ref_name }}

        ## What's New
        $tagMessage

        ## Downloads
        - **x64**: For modern 64-bit Windows (most common)
        - **x86**: For older or 32-bit Windows  
        - **portable**: Requires .NET 8 (smallest download)
        "@
        
        gh release create ${{ github.ref_name }} `
          --title "WinKeysRemapper ${{ github.ref_name }}" `
          --notes $releaseNotes `
          "WinKeysRemapper-${{ steps.version.outputs.version }}-x64.zip" `
          "WinKeysRemapper-${{ steps.version.outputs.version }}-x86.zip" `
          "WinKeysRemapper-${{ steps.version.outputs.version }}-portable.zip"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}